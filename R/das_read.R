#' Read DAS file
#'
#' Read fixed-width DAS textfile generated by WinCruz
#'
#' @param file filename of a DAS file
#' @param tz character; see \link[base]{strptime}. Default is UTC
#'
#' @importFrom dplyr %>%
#' @importFrom readr read_fwf
#' @importFrom readr cols
#' @importFrom readr col_character
#' @importFrom readr read_fwf
#' @importFrom readr fwf_positions
#' @importFrom utils tail
#'
#' @details Parses DAS data into columns; adapted
#'   from \code{\link[swfscMisc]{das.read}}.
#'   The provided file must follow the following column number and format
#'   specifications (note that 'Data#' columns may be referred to as
#'   'Field#' columns in other documentation):
#'   \tabular{lrr}{
#'     \emph{Item} \tab \emph{Columns} \tab \emph{Format}\cr
#'     Sequence (event number) \tab 1-3\cr
#'     Event \tab 4\cr
#'     Effort dot \tab 5\cr
#'     Time \tab 6-11 \tab HHMMSS or HHMM\cr
#'     Date \tab 13-18 \tab MMDDYY\cr
#'     Latitude \tab 20-28 \tab NDD:MM.MM\cr
#'     Longitude \tab 30-39 \tab WDDD:MM.MM\cr
#'     Data1 \tab 40-44 \cr
#'     Data2 \tab 45-49 \cr
#'     Data3 \tab 50-54\cr
#'     Data4 \tab 55-59\cr
#'     Data5 \tab 60-64\cr
#'     Data6 \tab 65-69\cr
#'     Data7 \tab 70-74\cr
#'     Data8 \tab 75+\cr
#'   }
#'
#'   TODO: handle non-UTF-8 symbols in comments.
#'
#' @return Data frame with aerial DAS data parsed into columns.
#'   The following columns were processed or added:
#'   \itemize{
#'     \item \code{EffortDot}: logical; \code{TRUE} if "." present, \code{FALSE otherwise}
#'     \item \code{DateTime}: \code{POSIXct}; combination of \code{Date} and \code{Time} columns
#'     \item \code{Lat}: \code{numeric}; decimal degrees in range [-90, 90]
#'     \item \code{Lon}: \code{numeric}; decimal degrees in range [-180, 180]
#'     \item \code{Data#}: leading/trailing whitespace trimmed for non-comment events (rows where \code{Event} is not "C" or "c")
#'     \item \code{file_das}: character; filename (note not full filepath)
#'     \item \code{line_num}: integer; line number of each data row
#'   }
#'
#' @examples
#' # TODO
#' # x <- das_read("../DAS_files/RV-Data/1986/MOPS0989.das")
#' # x <- das_read("../DAS_files/1986-2007ETP.das")
#'
#' @export
das_read <- function(file, tz = "UTC") {
  stopifnot(inherits(file, "character"))

  fwf.start <- c(1,4,5, 06,13, 20,21,24, 30,31,35, 40,45,50,55,60,65,70,75)
  fwf.end   <- c(3,4,5, 11,18, 20,22,28, 30,33,39, 44,49,54,59,64,69,74,NA)

  # suppressWarnings() is for lines that do not have data in all columns
  x <- suppressWarnings(read_fwf(
    file, col_positions = fwf_positions(start = fwf.start, end = fwf.end),
    skip_empty_rows = FALSE,
    na = c("", " ", "  ", "   ", "    ", "     ", "      "),
    col_types = cols(.default = col_character()),
    trim_ws = FALSE
  ))

  names(x) <- c("event_num", "Event", "EffortDot", "Time", "Date",
                "Lat1", "Lat2", "Lat3", "Lon1", "Lon2", "Lon3",
                "Data1", "Data2", "Data3", "Data4", "Data5", "Data6",
                "Data7", "Data8")

  # Process data, and add file and line number columns
  x$EffortDot <- ifelse(is.na(x$EffortDot), FALSE, TRUE)
  file_das  <- tail(strsplit(file, "/")[[1]], 1)
  event_num <- suppressWarnings(as.numeric(x$event_num)) #blank for # events
  line_num  <- seq_along(x$Event)

  Lat <- ifelse(x$Lat1 == "N", 1, -1) * (as.numeric(x$Lat2) + as.numeric(x$Lat3)/60)
  Lon <- ifelse(x$Lon1 == "E", 1, -1) * (as.numeric(x$Lon2) + as.numeric(x$Lon3)/60)
  # ll.na <- is.na(Lat) | is.na(Lon)
  # ll.na.event <- c("?", 1:8)
  # ll.na.which <- line_num[(!(x$Event %in% ll.na.event)) & ll.na]
  # if (length(dt.na.which) > 0) {
  #   warning("There are unexpected Lat and/or Lon NAs in row(s): ",
  #           paste(ll.na.which, collapse = ", "), ".\n",
  #           "'Unexpected' means for events other than: ",
  #           paste(ll.na.event, collapse = ", "))
  # }
  # rm(ll.na, ll.na.event, ll.na.which)

  DateTime <- strptime(paste(x$Date, x$Time), "%m%d%y %H%M%S", tz)
  dt.na <- is.na(DateTime)
  DateTime[dt.na] <- strptime(paste(x$Date, x$Time), "%m%d%y %H%M", tz)[dt.na]
  dt.na <- is.na(DateTime)
  dt.na.event <- c("*", "#", "?", "C", 1:8)
  dt.na.which <- which(!(x$Event[dt.na] %in% dt.na.event))
  if (length(dt.na.which) > 0) {
    warning("There are unexpected (i.e., for events other than ",
            paste(dt.na.event, collapse = ", "),
            ") DateTime NAs in row(s): ",
            paste(dt.na.which, collapse = ", "), ".\n")
  }
  rm(dt.na, dt.na.event, dt.na.which)

  y <- data.frame(
    Data1 = ifelse(x$Event == "C", x$Data1, trimws(x$Data1)),
    Data2 = ifelse(x$Event == "C", x$Data2, trimws(x$Data2)),
    Data3 = ifelse(x$Event == "C", x$Data3, trimws(x$Data3)),
    Data4 = ifelse(x$Event == "C", x$Data4, trimws(x$Data4)),
    Data5 = ifelse(x$Event == "C", x$Data5, trimws(x$Data5)),
    Data6 = ifelse(x$Event == "C", x$Data6, trimws(x$Data6)),
    Data7 = ifelse(x$Event == "C", x$Data7, trimws(x$Data7)),
    Data8 = ifelse(x$Event == "C",
                   ifelse(trimws(x$Data8) == "", NA, x$Data8),
                   trimws(x$Data8)),
    stringsAsFactors = FALSE
  )
  # Data8 extra ^ is for entries with >6 spaces (eg "       ")
  y[y == ""] <- NA

  # Data frame to return
  data.frame(
    Event = x$Event, EffortDot = x$EffortDot, DateTime, Lat, Lon, y,
    file_das, event_num, line_num,
    stringsAsFactors = FALSE
  )
}
